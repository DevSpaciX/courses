{% extends "course/base.html" %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'detail.css' %}">
{% endblock %}
{% block content %}
    <div class="container">
        <div class="row mx-auto">
            <div class="col-md3">
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-10 offset-1">
                        <h2 style="text-align: center">Frequently Asked Questions</h2>
                        <br/>
                        {{ course.title }}
                        {% if course in user.course_paid.all %}
                            {% for lecture in lectures %}
                                <details>
                                    <summary>{{ lecture.title }}</summary>
                                    <p> {{ lecture.text }}</p>
                                    <p> Homework : {{ lecture.home_work }}</p>
                                </details>
                            {% endfor %}
                        {% else %}
                            <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
                            <script src="https://js.stripe.com/v3/"></script>
                            <style>
                            </style>
                            <section>
                                <div class="product">
                                    <div class="description">
                                        <h3>{{ product.name }}</h3>
                                        <h5>${{ product.get_display_price }}</h5>
                                    </div>
                                </div>
                                <button class="btn-primary" type="button" id="checkout-button">Buy</button>
                            </section>
                            {% csrf_token %}
                            <script type="text/javascript">
                                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
                                var checkoutButton = document.getElementById("checkout-button");
                                checkoutButton.addEventListener("click", function () {
                                    fetch("{% url 'course:detail-page' product.id %}", {
                                        method: "POST",
                                        headers: {
                                            'X-CSRFToken': csrftoken
                                        }
                                    })
                                        .then(function (response) {
                                            return response.json();
                                        })
                                        .then(function (session) {
                                            return stripe.redirectToCheckout({sessionId: session.id});
                                        })
                                        .then(function (result) {
                                            if (result.error) {
                                                alert(result.error.message);
                                            }
                                        })
                                        .catch(function (error) {
                                            console.error("Error:", error);
                                        });
                                });
                            </script>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}